import React, { useState, useEffect, useRef } from 'react';
import { 
  UploadCloud, 
  FileAudio, 
  CheckCircle, 
  Play, 
  Pause, 
  Cpu, 
  List, 
  MessageSquare, 
  CalendarCheck, 
  Smile, 
  AlertCircle,
  Download,
  Copy,
  Trash2,
  Calendar,       // Google Calendar用
  FileText,       // Google Docs用
  Mail            // Gmail用
} from 'lucide-react';

// --- モックデータ（解析結果のシミュレーション用） ---
const MOCK_RESULT = {
  transcript: [
    { speaker: "A (田中)", text: "お世話になっております、株式会社テックの田中です。", time: "00:05" },
    { speaker: "B (佐藤)", text: "お世話になっております。デザイン事務所のアートの佐藤です。", time: "00:08" },
    { speaker: "A (田中)", text: "先日はお見積もりをお送りいただきありがとうございました。社内で検討しまして、ぜひ佐藤様にお願いしたいと思っております。", time: "00:15" },
    { speaker: "B (佐藤)", text: "ありがとうございます！大変光栄です。", time: "00:22" },
    { speaker: "A (田中)", text: "つきましては、来週のどこかでキックオフのミーティングを行いたいのですが、ご都合はいかがでしょうか？", time: "00:25" },
    { speaker: "B (佐藤)", text: "来週ですね。火曜日の14時以降か、水曜日の午前中であれば空いております。", time: "00:32" },
    { speaker: "A (田中)", text: "では、来週水曜日の午前10時からでいかがでしょうか？オンラインでZoomを使用しましょう。", time: "00:40" },
    { speaker: "B (佐藤)", text: "承知いたしました。水曜10時にZoomでよろしくお願いいたします。後ほどURLをお送りしますね。", time: "00:45" },
    { speaker: "A (田中)", text: "はい、よろしくお願いいたします。失礼いたします。", time: "00:50" },
  ],
  summary: [
    "株式会社テックの田中氏より、デザイン案件の正式発注の連絡。",
    "キックオフミーティングの日程調整を実施。",
    "ミーティングは来週水曜日の午前10時に決定。",
    "開催形式はZoomを使用する。"
  ],
  actionItems: [
    { assignee: "佐藤様", task: "ZoomのURLを発行し、田中氏へ送付する", deadline: "ミーティング前まで" },
    { assignee: "田中様・佐藤様", task: "キックオフミーティングへの参加", deadline: "来週水曜日 10:00" }
  ],
  sentiment: "Positive", // Positive, Neutral, Negative
  sentimentScore: 0.85
};

const App = () => {
  const [file, setFile] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [progress, setProgress] = useState(0);
  const [result, setResult] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const audioRef = useRef(null);
  const [activeTab, setActiveTab] = useState('summary');

  // ファイルアップロード処理
  const handleFileChange = (e) => {
    const selectedFile = e.target.files[0];
    if (selectedFile) {
      setFile(selectedFile);
      setResult(null);
      setProgress(0);
    }
  };

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  const handleDrop = (e) => {
    e.preventDefault();
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      setFile(e.dataTransfer.files[0]);
      setResult(null);
      setProgress(0);
    }
  };

  // 解析プロセスのシミュレーション
  const startProcessing = () => {
    setIsProcessing(true);
    setProgress(0);

    const interval = setInterval(() => {
      setProgress((prev) => {
        if (prev >= 100) {
          clearInterval(interval);
          setIsProcessing(false);
          setResult(MOCK_RESULT);
          return 100;
        }
        // ランダムに進捗を進める
        return prev + Math.floor(Math.random() * 15) + 5;
      });
    }, 500);
  };

  // プレイヤー制御
  const togglePlay = () => {
    if (audioRef.current) {
      if (isPlaying) {
        audioRef.current.pause();
      } else {
        // 実際のファイルがない場合はモック動作のみ
        if(audioRef.current.src) audioRef.current.play();
      }
      setIsPlaying(!isPlaying);
    }
  };

  // クリップボードにコピー
  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text);
    // 簡易的な通知などがあれば良いが今回は省略
    alert("テキストをコピーしました");
  };
  
  // Google API 連携のモック処理
  const handleGoogleIntegration = (service) => {
    alert(`${service} APIへの接続を開始します...（実装にはバックエンドとOAuth認証が必要です）`);
  };

  // リセット
  const resetApp = () => {
    setFile(null);
    setResult(null);
    setProgress(0);
    setIsProcessing(false);
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-indigo-100 selection:text-indigo-800">
      {/* ヘッダー */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center space-x-2">
            <div className="bg-indigo-600 p-2 rounded-lg">
              <Cpu className="w-5 h-5 text-white" />
            </div>
            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600">
              VoiceNote AI
            </h1>
          </div>
          <div className="flex items-center space-x-4">
            <span className="text-xs text-slate-400 hidden sm:inline">連携済み: Google Workspace</span>
            <button className="text-sm font-medium text-slate-500 hover:text-indigo-600 transition-colors">
              設定
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-5xl mx-auto px-4 py-8">
        
        {/* メインコンテンツエリア */}
        <div className="grid gap-8">
          
          {/* 1. ファイルアップロードエリア */}
          {!result && !isProcessing && (
            <div className="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 text-center transition-all duration-300 hover:shadow-md">
              <div 
                className="border-2 border-dashed border-slate-300 rounded-xl p-12 flex flex-col items-center justify-center bg-slate-50 hover:bg-indigo-50 hover:border-indigo-300 transition-colors cursor-pointer group"
                onDragOver={handleDragOver}
                onDrop={handleDrop}
              >
                {!file ? (
                  <>
                    <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4 group-hover:scale-110 transition-transform">
                      <UploadCloud className="w-8 h-8 text-indigo-500" />
                    </div>
                    <h3 className="text-lg font-bold text-slate-700 mb-2">音声ファイルをドロップ</h3>
                    <p className="text-slate-500 text-sm mb-6">または、ファイルを選択してください</p>
                    <label className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-full font-medium cursor-pointer transition-colors shadow-lg shadow-indigo-200">
                      ファイルを選択
                      <input type="file" className="hidden" accept="audio/*" onChange={handleFileChange} />
                    </label>
                    <p className="mt-4 text-xs text-slate-400">対応形式: mp3, wav, m4a (最大 50MB)</p>
                  </>
                ) : (
                  <div className="w-full max-w-md animate-fade-in">
                    <div className="flex items-center p-4 bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                      <div className="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mr-4 flex-shrink-0">
                        <FileAudio className="w-6 h-6 text-indigo-600" />
                      </div>
                      <div className="text-left flex-1 min-w-0">
                        <p className="font-semibold text-slate-800 truncate">{file.name}</p>
                        <p className="text-xs text-slate-500">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                      </div>
                      <button 
                        onClick={() => setFile(null)}
                        className="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full transition-colors"
                      >
                        <Trash2 className="w-5 h-5" />
                      </button>
                    </div>
                    
                    <button 
                      onClick={startProcessing}
                      className="w-full bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all active:scale-[0.98] flex items-center justify-center space-x-2"
                    >
                      <Cpu className="w-5 h-5" />
                      <span>AI解析を開始する</span>
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* 2. 処理中の表示 */}
          {isProcessing && (
            <div className="bg-white rounded-2xl p-12 shadow-sm border border-slate-200 text-center">
              <div className="max-w-md mx-auto">
                <div className="relative w-24 h-24 mx-auto mb-6">
                  <div className="absolute inset-0 rounded-full border-4 border-slate-100"></div>
                  <div className="absolute inset-0 rounded-full border-4 border-indigo-600 border-t-transparent animate-spin"></div>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <Cpu className="w-8 h-8 text-indigo-600 animate-pulse" />
                  </div>
                </div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">音声データを解析中...</h3>
                <p className="text-slate-500 mb-6">会話の内容を文字起こしし、要点をまとめています。</p>
                
                {/* プログレスバー */}
                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                  <div 
                    className="h-full bg-indigo-600 transition-all duration-300 ease-out rounded-full"
                    style={{ width: `${progress}%` }}
                  ></div>
                </div>
                <div className="flex justify-between text-xs text-slate-400 mt-2">
                  <span>アップロード</span>
                  <span>文字起こし</span>
                  <span>要約生成</span>
                </div>
              </div>
            </div>
          )}

          {/* 3. 結果表示エリア */}
          {result && !isProcessing && (
            <div className="animate-fade-in-up space-y-6">
              
              {/* プレイヤー＆基本情報 */}
              <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="flex items-center space-x-4 w-full md:w-auto">
                   <button 
                    onClick={togglePlay}
                    className="w-12 h-12 bg-indigo-600 hover:bg-indigo-700 rounded-full flex items-center justify-center text-white transition-colors shadow-md flex-shrink-0"
                  >
                    {isPlaying ? <Pause className="w-5 h-5" /> : <Play className="w-5 h-5 ml-1" />}
                  </button>
                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-slate-800 truncate">{file ? file.name : 'sample_audio.mp3'}</h3>
                    <p className="text-xs text-slate-500">00:52 • 完了</p>
                  </div>
                </div>
                
                {/* 波形（ビジュアルのみ） */}
                <div className="flex-1 w-full h-8 flex items-center space-x-1 px-4 opacity-50">
                  {[...Array(40)].map((_, i) => (
                    <div 
                      key={i} 
                      className="flex-1 bg-indigo-500 rounded-full transition-all duration-500"
                      style={{ 
                        height: `${Math.max(20, Math.random() * 100)}%`,
                        opacity: Math.random() > 0.5 ? 1 : 0.5
                      }}
                    ></div>
                  ))}
                </div>

                <div className="flex space-x-2">
                  <button 
                    onClick={resetApp}
                    className="p-2 text-slate-400 hover:bg-slate-100 rounded-lg transition-colors"
                    title="新しくアップロード"
                  >
                    <UploadCloud className="w-5 h-5" />
                  </button>
                  <button className="p-2 text-slate-400 hover:bg-slate-100 rounded-lg transition-colors">
                    <Download className="w-5 h-5" />
                  </button>
                </div>
                <audio ref={audioRef} src={file ? URL.createObjectURL(file) : ""} onEnded={() => setIsPlaying(false)} className="hidden" />
              </div>

              {/* ★ Google Workspace 連携バー ★ */}
              <div className="bg-indigo-50 rounded-xl p-4 border border-indigo-100 flex flex-col sm:flex-row items-center justify-between gap-4">
                <div className="flex items-center space-x-2 text-indigo-800">
                  <div className="bg-white p-1.5 rounded-md shadow-sm">
                    <img src="https://www.gstatic.com/images/branding/product/1x/google_workspace_48dp.png" alt="Workspace" className="w-6 h-6" />
                  </div>
                  <span className="font-semibold text-sm">解析結果を活用する</span>
                </div>
                <div className="flex space-x-3 w-full sm:w-auto">
                  <button 
                    onClick={() => handleGoogleIntegration('Docs')}
                    className="flex-1 sm:flex-none flex items-center justify-center space-x-2 bg-white hover:bg-indigo-100 text-slate-700 px-4 py-2 rounded-lg border border-slate-200 transition-colors text-sm font-medium"
                  >
                    <FileText className="w-4 h-4 text-blue-600" />
                    <span>Docsに保存</span>
                  </button>
                  <button 
                    onClick={() => handleGoogleIntegration('Calendar')}
                    className="flex-1 sm:flex-none flex items-center justify-center space-x-2 bg-white hover:bg-indigo-100 text-slate-700 px-4 py-2 rounded-lg border border-slate-200 transition-colors text-sm font-medium"
                  >
                    <Calendar className="w-4 h-4 text-green-600" />
                    <span>カレンダー登録</span>
                  </button>
                </div>
              </div>

              <div className="grid md:grid-cols-3 gap-6">
                
                {/* 左カラム：ナビゲーション & インサイト */}
                <div className="md:col-span-1 space-y-4">
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <nav className="flex flex-col">
                      <button 
                        onClick={() => setActiveTab('summary')}
                        className={`px-6 py-4 text-left font-medium flex items-center space-x-3 transition-colors ${activeTab === 'summary' ? 'bg-indigo-50 text-indigo-700 border-r-4 border-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}
                      >
                        <List className="w-5 h-5" />
                        <span>AI 要約</span>
                      </button>
                      <button 
                        onClick={() => setActiveTab('transcript')}
                        className={`px-6 py-4 text-left font-medium flex items-center space-x-3 transition-colors ${activeTab === 'transcript' ? 'bg-indigo-50 text-indigo-700 border-r-4 border-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}
                      >
                        <MessageSquare className="w-5 h-5" />
                        <span>全文文字起こし</span>
                      </button>
                      <button 
                        onClick={() => setActiveTab('action')}
                        className={`px-6 py-4 text-left font-medium flex items-center space-x-3 transition-colors ${activeTab === 'action' ? 'bg-indigo-50 text-indigo-700 border-r-4 border-indigo-600' : 'text-slate-600 hover:bg-slate-50'}`}
                      >
                        <CalendarCheck className="w-5 h-5" />
                        <span>ネクストアクション</span>
                        <span className="ml-auto bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full">{result.actionItems.length}</span>
                      </button>
                    </nav>
                  </div>

                  {/* 感情分析カード */}
                  <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center">
                      <Smile className="w-4 h-4 mr-2" />
                      会話の雰囲気
                    </h4>
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-2xl font-bold text-emerald-600">Positive</span>
                      <span className="text-sm text-slate-500">{Math.round(result.sentimentScore * 100)}%</span>
                    </div>
                    <div className="w-full bg-slate-100 rounded-full h-2">
                      <div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${result.sentimentScore * 100}%` }}></div>
                    </div>
                    <p className="text-xs text-slate-500 mt-3 leading-relaxed">
                      会話全体を通して前向きで建設的なトーンが検出されました。特に後半のスケジュール調整において合意形成がスムーズです。
                    </p>
                  </div>
                </div>

                {/* 右カラム：コンテンツ */}
                <div className="md:col-span-2">
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 min-h-[500px] flex flex-col">
                    
                    {/* タブ：要約 */}
                    {activeTab === 'summary' && (
                      <div className="p-8 animate-fade-in">
                        <div className="flex items-center justify-between mb-6">
                          <h2 className="text-xl font-bold text-slate-800 flex items-center">
                            <Cpu className="w-5 h-5 text-indigo-600 mr-2" />
                            重要ポイントの要約
                          </h2>
                          <button 
                            onClick={() => copyToClipboard(result.summary.join('\n'))}
                            className="p-2 hover:bg-slate-100 rounded-lg text-slate-400 transition-colors"
                            title="コピー"
                          >
                            <Copy className="w-4 h-4" />
                          </button>
                        </div>
                        <ul className="space-y-4">
                          {result.summary.map((point, idx) => (
                            <li key={idx} className="flex items-start">
                              <CheckCircle className="w-5 h-5 text-indigo-500 mr-3 mt-0.5 flex-shrink-0" />
                              <span className="text-slate-700 leading-relaxed">{point}</span>
                            </li>
                          ))}
                        </ul>
                        
                        <div className="mt-8 p-4 bg-yellow-50 rounded-xl border border-yellow-100 flex items-start">
                          <AlertCircle className="w-5 h-5 text-yellow-600 mr-3 mt-0.5 flex-shrink-0" />
                          <div>
                            <h4 className="font-bold text-yellow-800 text-sm mb-1">AIメモ</h4>
                            <p className="text-sm text-yellow-700">
                              「Zoom」という単語が検出されました。オンライン会議ツールの準備が必要です。
                            </p>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* タブ：文字起こし */}
                    {activeTab === 'transcript' && (
                      <div className="flex flex-col h-full animate-fade-in">
                        <div className="p-6 border-b border-slate-100 flex items-center justify-between bg-white rounded-t-2xl sticky top-0 z-10">
                          <h2 className="text-xl font-bold text-slate-800">全文文字起こし</h2>
                          <div className="flex space-x-2">
                            <button 
                              onClick={() => handleGoogleIntegration('Docs')}
                              className="text-xs font-medium bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg transition-colors flex items-center"
                            >
                              <FileText className="w-3 h-3 mr-1" />
                              Docsへ送る
                            </button>
                            <button 
                              onClick={() => copyToClipboard(result.transcript.map(t => `${t.speaker}: ${t.text}`).join('\n'))}
                              className="text-xs font-medium bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-lg text-slate-600 transition-colors"
                            >
                              すべてコピー
                            </button>
                          </div>
                        </div>
                        <div className="p-6 space-y-6 overflow-y-auto max-h-[600px]">
                          {result.transcript.map((item, idx) => (
                            <div key={idx} className="flex space-x-4">
                              <div className="flex-shrink-0 w-16 text-xs text-slate-400 font-mono pt-1 text-right">
                                {item.time}
                              </div>
                              <div className="flex-1">
                                <p className="text-xs font-bold text-indigo-600 mb-1">{item.speaker}</p>
                                <p className="text-slate-700 leading-relaxed">{item.text}</p>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* タブ：アクションアイテム */}
                    {activeTab === 'action' && (
                      <div className="p-8 animate-fade-in">
                        <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center">
                          <CalendarCheck className="w-5 h-5 text-indigo-600 mr-2" />
                          検出されたタスク
                        </h2>
                        <div className="space-y-4">
                          {result.actionItems.map((item, idx) => (
                            <div key={idx} className="bg-slate-50 rounded-xl p-5 border border-slate-200 flex items-start group">
                              <div className="h-6 w-6 rounded border-2 border-slate-300 mr-4 mt-0.5 cursor-pointer hover:border-indigo-500 transition-colors"></div>
                              <div className="flex-1">
                                <p className="font-semibold text-slate-800 mb-1">{item.task}</p>
                                <div className="flex items-center space-x-4 text-sm text-slate-500">
                                  <span className="flex items-center">
                                    <span className="w-2 h-2 bg-indigo-500 rounded-full mr-2"></span>
                                    {item.assignee}
                                  </span>
                                  <span className="text-slate-300">|</span>
                                  <span className="text-orange-600 font-medium">{item.deadline}</span>
                                </div>
                              </div>
                              <button 
                                onClick={() => handleGoogleIntegration('Calendar')}
                                className="opacity-0 group-hover:opacity-100 p-2 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-all"
                                title="Googleカレンダーに追加"
                              >
                                <Calendar className="w-5 h-5" />
                              </button>
                            </div>
                          ))}
                        </div>
                        <div className="mt-8 text-center">
                          <button className="text-indigo-600 text-sm font-medium hover:underline">
                            + タスクを手動で追加
                          </button>
                        </div>
                      </div>
                    )}

                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </main>
      
      {/* フッター */}
      <footer className="max-w-5xl mx-auto px-4 py-8 text-center text-slate-400 text-sm">
        <p>&copy; 2024 VoiceNote AI Prototype. </p>
        <p className="mt-2 text-xs">※このアプリはデモ版です。実際の音声解析はシミュレーション結果を表示しています。</p>
      </footer>

      {/* グローバルスタイル（アニメーション用） */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.5s ease-out forwards;
        }
      `}</style>
    </div>
  );
};

export default App;